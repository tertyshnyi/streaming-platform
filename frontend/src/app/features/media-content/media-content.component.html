<div class="custom-media-container" *ngIf="media as m">
  <app-sparkles></app-sparkles>

  <div class="custom-media-poster-background">
    <img [src]="m.coverImg" [alt]="m.title" />
    <div class="custom-gradient-overlay"></div>
  </div>

  <div class="custom-media-wrapper">
    <div class="custom-media-content">
      <div class="custom-media-left">
        <div class="custom-media-poster">
          <img [src]="m.posterImg" [alt]="m.title" />
          <button class="custom-trailer-button" (click)="openTrailer()">
            <span class="icon">▶</span> Watch trailer
          </button>
        </div>
      </div>

      <div class="custom-media-right">
        <div class="custom-media-details">
          <h1 class="custom-title">{{ m.title }}</h1>

          <div class="custom-genres">
            <span class="custom-badge" *ngFor="let genre of m.genres">{{ genre }}</span>
          </div>

          <div class="custom-description-wrapper" [class.expanded]="isDescriptionExpanded">
            <p class="custom-description">
              {{ m.description }}
            </p>
            <div class="fade-overlay"></div>
          </div>
          <div class="custom-expand-btn-wrapper">
            <button class="custom-expand-btn" (click)="toggleDescription()">
              {{ isDescriptionExpanded ? 'Show less' : 'Show more' }}
            </button>
          </div>

          <div class="custom-meta-grid">
            <div class="custom-meta-item" *ngIf="m.actors?.length">
              <strong>Directors</strong>
              <span>{{ m.directors.join(', ') }}</span>
            </div>
            <div class="custom-meta-item">
              <strong>Rating</strong>
              <span>{{ m.globalRating }}</span>
            </div>
            <div class="custom-meta-item" *ngIf="m.actors?.length">
              <strong>Actors</strong>
              <span>{{ m.actors.join(', ') }}</span>
            </div>
            <div class="custom-meta-item">
              <strong>Duration</strong>
              <span>{{ m.duration }}</span>
            </div>
            <div class="custom-meta-item" *ngIf="m.countries?.length">
              <strong>Countries</strong>
              <span>{{ m.countries.join(', ') }}</span>
            </div>
            <div class="custom-meta-item">
              <strong>Release date</strong>
              <span>{{ m.releaseDate | date }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="custom-plyr-video">
      <video
        #videoPlayer
        playsinline
        controls
        crossorigin
      ></video>
    </div>

    <div class="custom-comment-section">

      <div class="unauthorized-area">
        <h1>Account required</h1>
        <p>
          Please,
          <a routerLink="/auth">log in</a> or
          <a routerLink="/register">create an account</a>,
          to post a comment
        </p>
      </div>

      <div class="comments-info">
        <h3>Коментарі ({{ m.commentsTotal }})</h3>
        <button>СОРТУВАТИ</button>
      </div>

      <div class="authorized-area">
        <div class="reply-form" [class.active]="isNewCommentActive">
          <div class="top-form">
            <img src="/images/404-vdova.png" alt="your avatar" class="avatar" />
            <input
              type="text"
              placeholder="Написати коментар..."
              [(ngModel)]="newCommentInput"
              (focus)="isNewCommentActive = true"
              (blur)="onNewCommentInputBlur()"
              (keydown.enter)="sendNewComment()"
            />
          </div>
          <div class="bottom-form" *ngIf="isNewCommentActive">
            <button (click)="cancelNewComment()">Cancel</button>
            <button [disabled]="!newCommentInput.trim()" (click)="sendNewComment()">Submit</button>
          </div>
        </div>
      </div>

      <div class="comments-list">
        <div *ngFor="let rootComment of comments" class="comment">
          <img [src]="rootComment.profileImg" alt="avatar" class="avatar" />
          <div class="comment-body">
            <div class="comment-header">
              <strong>{{ rootComment.name }}</strong>
              <span class="comment-time">{{ rootComment.createdAt }}</span>
            </div>

            <div class="comment-text">
              {{ rootComment.content }}
            </div>

            <button class="answer-button" (click)="toggleReplyField(rootComment.id, rootComment.name)">
              <svg class="reply-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 8V5L3 12L10 19V16C17 16 20 20 21 21C20 15 17 10 10 8Z" />
              </svg>
              Відповісти
            </button>

            <div *ngIf="isReplyFieldVisible(rootComment.id)" class="reply-form">
              <div class="top-form">
                <img src="/images/404-vdova.png" alt="your avatar" class="avatar" />
                <input
                  type="text"
                  [placeholder]="'Відповідь ' + (replyRecipients[rootComment.id] || '')"
                  [(ngModel)]="replyInputs[rootComment.id]"
                />
              </div>
              <div class="bottom-form">
                <button (click)="cancelReply(rootComment.id)">Скасувати</button>
                <button (click)="sendReply(rootComment)">Відправити</button>
              </div>
            </div>

            <div class="comment-show" *ngIf="getAllDescendants(rootComment).length > 0">
              <button (click)="toggleReplies(rootComment.id)">
                <span class="arrow">{{ isRepliesVisible(rootComment.id) ? '▲' : '▼' }}</span>
                {{ isRepliesVisible(rootComment.id) ? 'Сховати відповіді' : 'Показати відповіді' }}
                ({{ getAllDescendants(rootComment).length }})
              </button>

              <div *ngIf="isRepliesVisible(rootComment.id)" class="comments-list" style="margin-left: 20px;">
                <div *ngFor="let childComment of getAllDescendants(rootComment)" class="comment">
                  <img [src]="childComment.profileImg" alt="avatar" class="avatar" />
                  <div class="comment-body">
                    <div class="comment-header">
                      <strong>{{ childComment.name }}</strong>
                      <span class="comment-time">{{ childComment.createdAt }}</span>
                    </div>

                    <div class="comment-text">
                      <span class="reply-to">{{ findParentName(childComment.parentId) }}</span> , {{ childComment.content }}
                    </div>

                    <button class="answer-button" (click)="toggleReplyField(childComment.id, childComment.name)">
                      <svg class="reply-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 8V5L3 12L10 19V16C17 16 20 20 21 21C20 15 17 10 10 8Z" />
                      </svg>
                      Відповісти
                    </button>

                    <div *ngIf="isReplyFieldVisible(childComment.id)" class="reply-form">
                      <div class="top-form">
                        <img src="/images/404-vdova.png" alt="your avatar" class="avatar" />
                        <input
                          type="text"
                          [placeholder]="'Відповідь ' + (replyRecipients[childComment.id] || '')"
                          [(ngModel)]="replyInputs[childComment.id]"
                        />
                      </div>
                      <div class="bottom-form">
                        <button (click)="cancelReply(childComment.id)">Скасувати</button>
                        <button (click)="sendReply(childComment)">Відправити</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="trailer-modal" *ngIf="isTrailerOpen" (click)="closeTrailer()">
    <div class="trailer-modal-content-wrapper">
      <button class="close-button" (click)="closeTrailer()">✕</button>

      <div class="trailer-modal-content" (click)="$event.stopPropagation()">
        <iframe
          *ngIf="m?.trailerUrl"
          [src]="getYouTubeEmbedUrl(m?.trailerUrl)"
          frameborder="0"
          allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>
      </div>
    </div>
  </div>
</div>
